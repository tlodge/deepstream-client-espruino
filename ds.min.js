!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("ws")):"function"==typeof define&&define.amd?define(["ws"],e):"object"==typeof exports?exports.dsclient=e(require("ws")):t.dsclient=e(t.ws)}(global,(function(t){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var s=e[i]={i:i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(i,s,function(e){return t[e]}.bind(null,s));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=5)}([function(t,e){e.CONNECTION_STATE={},e.CONNECTION_STATE.CLOSED="CLOSED",e.CONNECTION_STATE.AWAITING_CONNECTION="AWAITING_CONNECTION",e.CONNECTION_STATE.CHALLENGING="CHALLENGING",e.CONNECTION_STATE.AWAITING_AUTHENTICATION="AWAITING_AUTHENTICATION",e.CONNECTION_STATE.AUTHENTICATING="AUTHENTICATING",e.CONNECTION_STATE.OPEN="OPEN",e.CONNECTION_STATE.ERROR="ERROR",e.CONNECTION_STATE.RECONNECTING="RECONNECTING",e.MESSAGE_SEPERATOR=String.fromCharCode(30),e.MESSAGE_PART_SEPERATOR=String.fromCharCode(31),e.TYPES={},e.TYPES.STRING="S",e.TYPES.OBJECT="O",e.TYPES.NUMBER="N",e.TYPES.NULL="L",e.TYPES.TRUE="T",e.TYPES.FALSE="F",e.TYPES.UNDEFINED="U",e.TOPIC={},e.TOPIC.CONNECTION="C",e.TOPIC.AUTH="A",e.TOPIC.ERROR="X",e.TOPIC.EVENT="E",e.TOPIC.RECORD="R",e.TOPIC.RPC="P",e.TOPIC.PRESENCE="U",e.TOPIC.PRIVATE="PRIVATE/",e.EVENT={},e.EVENT.CONNECTION_ERROR="connectionError",e.EVENT.CONNECTION_STATE_CHANGED="connectionStateChanged",e.EVENT.MAX_RECONNECTION_ATTEMPTS_REACHED="MAX_RECONNECTION_ATTEMPTS_REACHED",e.EVENT.CONNECTION_AUTHENTICATION_TIMEOUT="CONNECTION_AUTHENTICATION_TIMEOUT",e.EVENT.ACK_TIMEOUT="ACK_TIMEOUT",e.EVENT.NO_RPC_PROVIDER="NO_RPC_PROVIDER",e.EVENT.RESPONSE_TIMEOUT="RESPONSE_TIMEOUT",e.EVENT.DELETE_TIMEOUT="DELETE_TIMEOUT",e.EVENT.UNSOLICITED_MESSAGE="UNSOLICITED_MESSAGE",e.EVENT.MESSAGE_DENIED="MESSAGE_DENIED",e.EVENT.MESSAGE_PARSE_ERROR="MESSAGE_PARSE_ERROR",e.EVENT.VERSION_EXISTS="VERSION_EXISTS",e.EVENT.NOT_AUTHENTICATED="NOT_AUTHENTICATED",e.EVENT.MESSAGE_PERMISSION_ERROR="MESSAGE_PERMISSION_ERROR",e.EVENT.LISTENER_EXISTS="LISTENER_EXISTS",e.EVENT.NOT_LISTENING="NOT_LISTENING",e.EVENT.TOO_MANY_AUTH_ATTEMPTS="TOO_MANY_AUTH_ATTEMPTS",e.EVENT.INVALID_AUTH_MSG="INVALID_AUTH_MSG",e.EVENT.IS_CLOSED="IS_CLOSED",e.EVENT.RECORD_NOT_FOUND="RECORD_NOT_FOUND",e.EVENT.NOT_SUBSCRIBED="NOT_SUBSCRIBED",e.ACTIONS={},e.ACTIONS.PING="PI",e.ACTIONS.PONG="PO",e.ACTIONS.ACK="A",e.ACTIONS.REDIRECT="RED",e.ACTIONS.CHALLENGE="CH",e.ACTIONS.CHALLENGE_RESPONSE="CHR",e.ACTIONS.READ="R",e.ACTIONS.CREATE="C",e.ACTIONS.UPDATE="U",e.ACTIONS.PATCH="P",e.ACTIONS.DELETE="D",e.ACTIONS.SUBSCRIBE="S",e.ACTIONS.UNSUBSCRIBE="US",e.ACTIONS.HAS="H",e.ACTIONS.HEAD="HD",e.ACTIONS.SNAPSHOT="SN",e.ACTIONS.INVOKE="I",e.ACTIONS.SUBSCRIPTION_FOR_PATTERN_FOUND="SP",e.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED="SR",e.ACTIONS.SUBSCRIPTION_HAS_PROVIDER="SH",e.ACTIONS.LISTEN="L",e.ACTIONS.UNLISTEN="UL",e.ACTIONS.LISTEN_ACCEPT="LA",e.ACTIONS.LISTEN_REJECT="LR",e.ACTIONS.PROVIDER_UPDATE="PU",e.ACTIONS.QUERY="Q",e.ACTIONS.CREATEORREAD="CR",e.ACTIONS.CREATEANDUPDATE="CU",e.ACTIONS.EVENT="EVT",e.ACTIONS.ERROR="E",e.ACTIONS.REQUEST="REQ",e.ACTIONS.RESPONSE="RES",e.ACTIONS.REJECTION="REJ",e.ACTIONS.PRESENCE_JOIN="PNJ",e.ACTIONS.PRESENCE_LEAVE="PNL",e.ACTIONS.WRITE_ACKNOWLEDGEMENT="WA",e.CALL_STATE={},e.CALL_STATE.INITIAL="INITIAL",e.CALL_STATE.CONNECTING="CONNECTING",e.CALL_STATE.ESTABLISHED="ESTABLISHED",e.CALL_STATE.ACCEPTED="ACCEPTED",e.CALL_STATE.DECLINED="DECLINED",e.CALL_STATE.ENDED="ENDED",e.CALL_STATE.ERROR="ERROR"},function(t,e,n){function i(t){if(t)return function(t){for(var e in i.prototype)t[e]=i.prototype[e];return t}(t)}t.exports=i,i.prototype.on=i.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||Object.create(null),(this._callbacks[t]=this._callbacks[t]||[]).push(e),this},i.prototype.once=function(t,e){function n(){this.off(t,n),e.apply(this,arguments)}return n.fn=e,this.on(t,n),this},i.prototype.off=i.prototype.removeListener=i.prototype.removeAllListeners=i.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||Object.create(null),0==arguments.length)return this._callbacks=Object.create(null),this;var n,i=this._callbacks[t];if(!i)return this;if(1==arguments.length)return delete this._callbacks[t],this;for(var s=0;s<i.length;s++)if((n=i[s])===e||n.fn===e){i.splice(s,1);break}return 0===i.length&&delete this._callbacks[t],this},i.prototype.emit=function(t){this._callbacks=this._callbacks||Object.create(null);for(var e=new Array(arguments.length-1),n=this._callbacks[t],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(n){i=0;for(var s=(n=n.slice(0)).length;i<s;++i)n[i].apply(this,e)}return this},i.prototype.listeners=function(t){return this._callbacks=this._callbacks||Object.create(null),this._callbacks[t]||[]},i.prototype.hasListeners=function(t){return!!this.listeners(t).length},i.prototype.eventNames=function(){return this._callbacks?Object.keys(this._callbacks):[]}},function(t,e,n){"use strict";const i=n(0),s=function(){this._actions=this._getActions()};s.prototype.parse=function(t,e){const n=[],s=t.split(i.MESSAGE_SEPERATOR);for(let t=0;t<s.length;t++)s[t].length>2&&n.push(this._parseMessage(s[t],e));return n},s.prototype.convertTyped=function(t,e){const n=t.charAt(0);if(n===i.TYPES.STRING)return t.substr(1);if(n===i.TYPES.OBJECT)try{return JSON.parse(t.substr(1))}catch(n){return void e._$onError(i.TOPIC.ERROR,i.EVENT.MESSAGE_PARSE_ERROR,`${n.toString()}(${t})`)}return n===i.TYPES.NUMBER?parseFloat(t.substr(1)):n===i.TYPES.NULL?null:n===i.TYPES.TRUE||n!==i.TYPES.FALSE&&void(n!==i.TYPES.UNDEFINED&&e._$onError(i.TOPIC.ERROR,i.EVENT.MESSAGE_PARSE_ERROR,`UNKNOWN_TYPE (${t})`))},s.prototype._getActions=function(){const t={};for(const e in i.ACTIONS)t[i.ACTIONS[e]]=e;return t},s.prototype._parseMessage=function(t,e){const n=t.split(i.MESSAGE_PART_SEPERATOR),s={};return n.length<2?(e._$onError(i.TOPIC.ERROR,i.EVENT.MESSAGE_PARSE_ERROR,"Insufficiant message parts"),null):void 0===this._actions[n[1]]?(e._$onError(i.TOPIC.ERROR,i.EVENT.MESSAGE_PARSE_ERROR,`Unknown action ${n[1]}`),null):(s.raw=t,s.topic=n[0],s.action=n[1],s.data=n.splice(2),s)},t.exports=new s},function(t,e,n){"use strict";const i=n(0),s=i.MESSAGE_PART_SEPERATOR;e.getMsg=function(t,e,n){if(n&&!(n instanceof Array))throw new Error("data must be an array");const o=[t,e];if(n)for(let t=0;t<n.length;t++)"object"==typeof n[t]?o.push(JSON.stringify(n[t])):o.push(n[t]);return o.join(s)+i.MESSAGE_SEPERATOR},e.typed=function(t){const e=typeof t;if("string"===e)return i.TYPES.STRING+t;if(null===t)return i.TYPES.NULL;if("object"===e)return i.TYPES.OBJECT+JSON.stringify(t);if("number"===e)return i.TYPES.NUMBER+t.toString();if(!0===t)return i.TYPES.TRUE;if(!1===t)return i.TYPES.FALSE;if(void 0===t)return i.TYPES.UNDEFINED;throw new Error(`Can't serialize type ${t}`)}},function(t,e,n){"use strict";const i=n(0),s=function(t,e){this._client=t,this._resubscribe=e,this._isReconnecting=!1,this._connectionStateChangeHandler=this._handleConnectionStateChanges.bind(this),this._client.on("connectionStateChanged",this._connectionStateChangeHandler)};s.prototype.destroy=function(){this._client.removeListener("connectionStateChanged",this._connectionStateChangeHandler),this._connectionStateChangeHandler=null,this._client=null},s.prototype._handleConnectionStateChanges=function(){const t=this._client.getConnectionState();t===i.CONNECTION_STATE.RECONNECTING&&!1===this._isReconnecting&&(this._isReconnecting=!0),t===i.CONNECTION_STATE.OPEN&&!0===this._isReconnecting&&(this._isReconnecting=!1,this._resubscribe())},t.exports=s},function(t,e,n){"use strict";const i=n(0),s=n(1),o=n(6),r=n(10),c=n(12),a=n(14),E=function(t,e){this._url=t,this._options=this._getOptions(e||{}),this._connection=new o(this,this._url,this._options),this._ackTimeoutRegistry=new a(this,this._options),this.event=new r(this._options,this._connection,this),this._messageCallbacks={},this._messageCallbacks[i.TOPIC.EVENT]=this.event._$handle.bind(this.event),this._messageCallbacks[i.TOPIC.ERROR]=this._onErrorMessage.bind(this),e&&e.silentDeprecation||console.log("deepstream V3 is in maintenance mode\n  It's heavily recommended you use V4 (@deepstream/client)\n  You can see the changlogs here https://deepstream.io/releases/client-js/v4-0-0/\n  The server V4.1 supports text protocol if your require to use other non official\n  SDKs and resolves many of the issues in V3.\n  To silence this warning just pass in a silentDeprecation flag in options.\n  Example: deepstream(url, { silentDeprecation: true })\n")};function T(t,e){return new E(t,e)}s(E.prototype),E.prototype.login=function(t,e){return"function"==typeof t?this._connection.authenticate({},t):this._connection.authenticate(t||{},e),this},E.prototype.loginAsync=function(t){return new Promise((e,n)=>{this._connection.authenticate(t||{},(t,i)=>{t?e(i):n(i)})})},E.prototype.close=function(){this._connection.close()},E.prototype.getConnectionState=function(){return this._connection.getState()},E.prototype.getUid=function(){return`${(new Date).getTime().toString(36)}-${(1e16*Math.random()).toString(36).replace(".","")}`},E.prototype._$getAckTimeoutRegistry=function(){return this._ackTimeoutRegistry},E.prototype._$onMessage=function(t){this._messageCallbacks[t.topic]?this._messageCallbacks[t.topic](t):(t.processedError=!0,this._$onError(t.topic,i.EVENT.MESSAGE_PARSE_ERROR,`Received message for unknown topic ${t.topic}`)),t.action!==i.ACTIONS.ERROR||t.processedError||this._$onError(t.topic,t.data[0],t.data.slice(0))},E.prototype._$onError=function(t,e,n){let s;if(e!==i.EVENT.ACK_TIMEOUT&&e!==i.EVENT.RESPONSE_TIMEOUT||this.getConnectionState()===i.CONNECTION_STATE.AWAITING_AUTHENTICATION&&(s="Your message timed out because you're not authenticated. Have you called login()?",setTimeout(this._$onError.bind(this,i.EVENT.NOT_AUTHENTICATED,i.TOPIC.ERROR,s),1)),!this.hasListeners("error"))throw console.log("--- You can catch all deepstream errors by subscribing to the error event ---"),s=`${e}: ${n}`,t&&(s+=` (${t})`),new Error(s);this.emit("error",n,e,t),this.emit(e,t,n)},E.prototype._onErrorMessage=function(t){this._$onError(t.topic,t.data[0],t.data[1])},E.prototype._getOptions=function(t){const e={};for(const n in c)void 0===t[n]?e[n]=c[n]:e[n]=t[n];return e},E.prototype.CONSTANTS=i,T.CONSTANTS=i,t.exports=T},function(t,e,n){"use strict";const i=n(7),s=n(2),o=n(3),r=n(8),c=n(0),a=function(t,e,n){this._client=t,this._options=n,this._authParams=null,this._authCallback=null,this._deliberateClose=!1,this._redirecting=!1,this._tooManyAuthAttempts=!1,this._connectionAuthenticationTimeout=!1,this._challengeDenied=!1,this._queuedMessages=[],this._reconnectTimeout=null,this._reconnectionAttempt=0,this._currentPacketMessageCount=0,this._sendNextPacketTimeout=null,this._currentMessageResetTimeout=null,this._endpoint=null,this._lastHeartBeat=null,this._heartbeatInterval=null,this._originalUrl=r.parseUrl(e,this._options.path),this._url=this._originalUrl,this._state=c.CONNECTION_STATE.CLOSED,this._createEndpoint()};a.prototype.getState=function(){return this._state},a.prototype.authenticate=function(t,e){if("object"==typeof t){if(this._authParams=t,this._authCallback=e,!(this._tooManyAuthAttempts||this._challengeDenied||this._connectionAuthenticationTimeout))return!0===this._deliberateClose&&this._state===c.CONNECTION_STATE.CLOSED?(this._createEndpoint(),void(this._deliberateClose=!1)):void(this._state===c.CONNECTION_STATE.AWAITING_AUTHENTICATION&&this._sendAuthParams());this._client._$onError(c.TOPIC.ERROR,c.EVENT.IS_CLOSED,"this client's connection was closed")}else this._client._$onError(c.TOPIC.ERROR,c.EVENT.INVALID_AUTH_MSG,"authParams is not an object")},a.prototype.sendMsg=function(t,e,n){this.send(o.getMsg(t,e,n))},a.prototype.send=function(t){this._queuedMessages.push(t),this._currentPacketMessageCount++,null===this._currentMessageResetTimeout&&(this._currentMessageResetTimeout=r.nextTick(this._resetCurrentMessageCount.bind(this))),this._state===c.CONNECTION_STATE.OPEN&&this._queuedMessages.length<this._options.maxMessagesPerPacket&&this._currentPacketMessageCount<this._options.maxMessagesPerPacket?this._sendQueuedMessages():null===this._sendNextPacketTimeout&&this._queueNextPacket()},a.prototype.close=function(){clearInterval(this._heartbeatInterval),this._deliberateClose=!0,this._endpoint.close(),this._setState(c.CONNECTION_STATE.CLOSED)},a.prototype._createEndpoint=function(){this._endpoint=new i(this._url,this._options.nodeSocketOptions),this._endpoint.onopen=this._onOpen.bind(this),this._endpoint.onerror=this._onError.bind(this),this._endpoint.onclose=this._onClose.bind(this),this._endpoint.onmessage=this._onMessage.bind(this)},a.prototype._resetCurrentMessageCount=function(){this._currentPacketMessageCount=0,this._currentMessageResetTimeout=null},a.prototype._sendQueuedMessages=function(){if(this._state!==c.CONNECTION_STATE.OPEN||this._endpoint.readyState!==this._endpoint.OPEN)return;if(0===this._queuedMessages.length)return void(this._sendNextPacketTimeout=null);const t=this._queuedMessages.splice(0,this._options.maxMessagesPerPacket).join("");0!==this._queuedMessages.length?this._queueNextPacket():this._sendNextPacketTimeout=null,this._submit(t)},a.prototype._submit=function(t){this._endpoint.readyState===this._endpoint.OPEN?this._endpoint.send(t):this._onError("Tried to send message on a closed websocket connection")},a.prototype._queueNextPacket=function(){const t=this._sendQueuedMessages.bind(this),e=this._options.timeBetweenSendingQueuedPackages;this._sendNextPacketTimeout=setTimeout(t,e)},a.prototype._sendAuthParams=function(){this._setState(c.CONNECTION_STATE.AUTHENTICATING);const t=o.getMsg(c.TOPIC.AUTH,c.ACTIONS.REQUEST,[this._authParams]);this._submit(t)},a.prototype._checkHeartBeat=function(){const t=2*this._options.heartbeatInterval;Date.now()-this._lastHeartBeat>t&&(clearInterval(this._heartbeatInterval),this._endpoint.close(),this._client._$onError(c.TOPIC.CONNECTION,c.EVENT.CONNECTION_ERROR,`heartbeat not received in the last ${t} milliseconds`))},a.prototype._onOpen=function(){this._clearReconnect(),this._lastHeartBeat=Date.now(),this._heartbeatInterval=r.setInterval(this._checkHeartBeat.bind(this),this._options.heartbeatInterval),this._setState(c.CONNECTION_STATE.AWAITING_CONNECTION)},a.prototype._onError=function(t){clearInterval(this._heartbeatInterval),this._setState(c.CONNECTION_STATE.ERROR),setTimeout(()=>{let e;if("ECONNRESET"===t.code||"ECONNREFUSED"===t.code)e=`Can't connect! Deepstream server unreachable on ${this._originalUrl}`;else try{e=JSON.stringify(t)}catch(n){e=t.toString()}this._client._$onError(c.TOPIC.CONNECTION,c.EVENT.CONNECTION_ERROR,e)},1)},a.prototype._onClose=function(){clearInterval(this._heartbeatInterval),!0===this._redirecting?(this._redirecting=!1,this._createEndpoint()):!0===this._deliberateClose?this._setState(c.CONNECTION_STATE.CLOSED):this._tryReconnect()},a.prototype._onMessage=function(t){const e=s.parse(t.data,this._client);for(let t=0;t<e.length;t++)null!==e[t]&&(e[t].topic===c.TOPIC.CONNECTION?this._handleConnectionResponse(e[t]):e[t].topic===c.TOPIC.AUTH?this._handleAuthResponse(e[t]):this._client._$onMessage(e[t]))},a.prototype._handleConnectionResponse=function(t){t.action===c.ACTIONS.PING?(this._lastHeartBeat=Date.now(),this._submit(o.getMsg(c.TOPIC.CONNECTION,c.ACTIONS.PONG))):t.action===c.ACTIONS.ACK?(this._setState(c.CONNECTION_STATE.AWAITING_AUTHENTICATION),this._authParams&&this._sendAuthParams()):t.action===c.ACTIONS.CHALLENGE?(this._setState(c.CONNECTION_STATE.CHALLENGING),this._submit(o.getMsg(c.TOPIC.CONNECTION,c.ACTIONS.CHALLENGE_RESPONSE,[this._originalUrl]))):t.action===c.ACTIONS.REJECTION?(this._challengeDenied=!0,this.close()):t.action===c.ACTIONS.REDIRECT?(this._url=t.data[0],this._redirecting=!0,this._endpoint.close()):t.action===c.ACTIONS.ERROR&&t.data[0]===c.EVENT.CONNECTION_AUTHENTICATION_TIMEOUT&&(this._deliberateClose=!0,this._connectionAuthenticationTimeout=!0,this._client._$onError(c.TOPIC.CONNECTION,t.data[0],t.data[1]))},a.prototype._handleAuthResponse=function(t){if(t.action===c.ACTIONS.ERROR){if(t.data[0]===c.EVENT.TOO_MANY_AUTH_ATTEMPTS)this._deliberateClose=!0,this._tooManyAuthAttempts=!0;else{if(t.data[0]===c.EVENT.INVALID_AUTH_MSG)return this._deliberateClose=!0,void(this._authCallback&&this._authCallback(!1,"invalid authentication message"));this._setState(c.CONNECTION_STATE.AWAITING_AUTHENTICATION)}this._authCallback&&this._authCallback(!1,this._getAuthData(t.data[1]))}else t.action===c.ACTIONS.ACK&&(this._setState(c.CONNECTION_STATE.OPEN),this._authCallback&&this._authCallback(!0,this._getAuthData(t.data[0])),this._sendQueuedMessages())},a.prototype._getAuthData=function(t){return void 0===t?null:s.convertTyped(t,this._client)},a.prototype._setState=function(t){this._state=t,this._client.emit(c.EVENT.CONNECTION_STATE_CHANGED,t)},a.prototype._tryReconnect=function(){null===this._reconnectTimeout&&(this._reconnectionAttempt<this._options.maxReconnectAttempts?(this._setState(c.CONNECTION_STATE.RECONNECTING),this._reconnectTimeout=setTimeout(this._tryOpen.bind(this),Math.min(this._options.maxReconnectInterval,this._options.reconnectIntervalIncrement*this._reconnectionAttempt)),this._reconnectionAttempt++):(this._clearReconnect(),this.close(),this._client.emit(c.EVENT.MAX_RECONNECTION_ATTEMPTS_REACHED,this._reconnectionAttempt)))},a.prototype._tryOpen=function(){this._originalUrl!==this._url&&(this._url=this._originalUrl),this._createEndpoint(),this._reconnectTimeout=null},a.prototype._clearReconnect=function(){clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null,this._reconnectionAttempt=0},t.exports=a},function(e,n){e.exports=t},function(t,e,n){"use strict";const i=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;e.isNode="undefined"!=typeof process&&"[object process]"===process.toString(),e.nextTick=function(t){e.isNode?process.nextTick(t):setTimeout(t,0)},e.trim=function(t){return t.trim?t.trim():t.replace(i,"")},e.setTimeout=function(t,e){return null!==e?setTimeout(t,e):-1},e.setInterval=function(t,e){return null!==e?setInterval(t,e):-1};const s=/^wss:|^ws:|^\/\//,o=/^http:|^https:/,r=n(9);e.parseUrl=function(t,e){let n=t;if(o.test(n))throw new Error("Only ws and wss are supported");s.test(n)?0===n.indexOf("//")&&(n=`ws:${n}`):n=`ws://${n}`;const i=r.parse(n);if(!i.host)throw new Error("invalid url, missing host");return i.protocol=i.protocol?i.protocol:"ws:","/"===i.pathname&&"/"!==t.charAt(t.length-1)&&(i.pathname=e),i.pathname=i.pathname?i.pathname:e,r.format(i)},e.isConnected=function(t){return t.getConnectionState()===C.CONNECTION_STATE.OPEN}},function(t,e){t.exports=require("url")},function(t,e,n){"use strict";const i=n(3),s=n(2),o=n(4),r=n(0),c=n(11),a=n(1),E=function(t,e,n){this._options=t,this._connection=e,this._client=n,this._emitter=new a,this._listener={},this._ackTimeoutRegistry=n._$getAckTimeoutRegistry(),this._resubscribeNotifier=new o(this._client,this._resubscribe.bind(this))};E.prototype.eventNames=function(){return this._emitter.eventNames()},E.prototype.subscribe=function(t,e){if("string"!=typeof t||0===t.length)throw new Error("invalid argument name");if("function"!=typeof e)throw new Error("invalid argument callback");this._emitter.hasListeners(t)||(this._ackTimeoutRegistry.add({topic:r.TOPIC.EVENT,action:r.ACTIONS.SUBSCRIBE,name:t}),this._connection.sendMsg(r.TOPIC.EVENT,r.ACTIONS.SUBSCRIBE,[t])),this._emitter.on(t,e)},E.prototype.unsubscribe=function(t,e){if("string"!=typeof t||0===t.length)throw new Error("invalid argument name");if(void 0!==e&&"function"!=typeof e)throw new Error("invalid argument callback");this._emitter.off(t,e),this._emitter.hasListeners(t)||(this._ackTimeoutRegistry.add({topic:r.TOPIC.EVENT,action:r.ACTIONS.UNSUBSCRIBE,name:t}),this._connection.sendMsg(r.TOPIC.EVENT,r.ACTIONS.UNSUBSCRIBE,[t]))},E.prototype.emit=function(t,e){if("string"!=typeof t||0===t.length)throw new Error("invalid argument name");this._connection.sendMsg(r.TOPIC.EVENT,r.ACTIONS.EVENT,[t,i.typed(e)]),this._emitter.emit(t,e)},E.prototype.listen=function(t,e){if("string"!=typeof t||0===t.length)throw new Error("invalid argument pattern");if("function"!=typeof e)throw new Error("invalid argument callback");!this._listener[t]||this._listener[t].destroyPending?(this._listener[t]&&this._listener[t].destroy(),this._listener[t]=new c(r.TOPIC.EVENT,t,e,this._options,this._client,this._connection)):this._client._$onError(r.TOPIC.EVENT,r.EVENT.LISTENER_EXISTS,t)},E.prototype.unlisten=function(t){if("string"!=typeof t||0===t.length)throw new Error("invalid argument pattern");const e=this._listener[t];e&&!e.destroyPending?e.sendDestroy():this._listener[t]?(this._ackTimeoutRegistry.add({topic:r.TOPIC.EVENT,action:r.EVENT.UNLISTEN,name:t}),this._listener[t].destroy(),delete this._listener[t]):this._client._$onError(r.TOPIC.RECORD,r.EVENT.NOT_LISTENING,t)},E.prototype._$handle=function(t){const e=t.data[t.action===r.ACTIONS.ACK?1:0];if(t.action!==r.ACTIONS.EVENT){if(t.action===r.ACTIONS.ACK&&t.data[0]===r.ACTIONS.UNLISTEN&&this._listener[e]&&this._listener[e].destroyPending)return this._listener[e].destroy(),void delete this._listener[e];if(this._listener[e])this._listener[e]._$onMessage(t);else if(t.action!==r.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED&&t.action!==r.ACTIONS.SUBSCRIPTION_HAS_PROVIDER){if(t.action!==r.ACTIONS.ACK)return t.action===r.ACTIONS.ERROR?(t.data[0]===r.EVENT.MESSAGE_DENIED?this._ackTimeoutRegistry.remove({topic:r.TOPIC.EVENT,name:t.data[1],action:t.data[2]}):t.data[0]===r.EVENT.NOT_SUBSCRIBED&&this._ackTimeoutRegistry.remove({topic:r.TOPIC.EVENT,name:t.data[1],action:r.ACTIONS.UNSUBSCRIBE}),t.processedError=!0,void this._client._$onError(r.TOPIC.EVENT,t.data[0],t.data[1])):void this._client._$onError(r.TOPIC.EVENT,r.EVENT.UNSOLICITED_MESSAGE,e);this._ackTimeoutRegistry.clear(t)}}else t.data&&2===t.data.length?this._emitter.emit(e,s.convertTyped(t.data[1],this._client)):this._emitter.emit(e)},E.prototype._resubscribe=function(){const t=this._emitter._callbacks;for(const e in t)this._connection.sendMsg(r.TOPIC.EVENT,r.ACTIONS.SUBSCRIBE,[e])},t.exports=E},function(t,e,n){"use strict";const i=n(0),s=n(4),o=function(t,e,n,o,r,c){this._topic=t,this._callback=n,this._pattern=e,this._options=o,this._client=r,this._connection=c,this._ackTimeoutRegistry=r._$getAckTimeoutRegistry(),this._ackTimeoutRegistry.add({topic:this._topic,name:e,action:i.ACTIONS.LISTEN}),this._resubscribeNotifier=new s(r,this._sendListen.bind(this)),this._sendListen(),this.destroyPending=!1};o.prototype.sendDestroy=function(){this.destroyPending=!0,this._connection.sendMsg(this._topic,i.ACTIONS.UNLISTEN,[this._pattern]),this._resubscribeNotifier.destroy()},o.prototype.destroy=function(){this._callback=null,this._pattern=null,this._client=null,this._connection=null},o.prototype.accept=function(t){this._connection.sendMsg(this._topic,i.ACTIONS.LISTEN_ACCEPT,[this._pattern,t])},o.prototype.reject=function(t){this._connection.sendMsg(this._topic,i.ACTIONS.LISTEN_REJECT,[this._pattern,t])},o.prototype._createCallbackResponse=function(t){return{accept:this.accept.bind(this,t.data[1]),reject:this.reject.bind(this,t.data[1])}},o.prototype._$onMessage=function(t){t.action===i.ACTIONS.ACK?this._ackTimeoutRegistry.clear(t):t.action===i.ACTIONS.SUBSCRIPTION_FOR_PATTERN_FOUND?this._callback(t.data[1],!0,this._createCallbackResponse(t)):t.action===i.ACTIONS.SUBSCRIPTION_FOR_PATTERN_REMOVED?this._callback(t.data[1],!1):this._client._$onError(this._topic,i.EVENT.UNSOLICITED_MESSAGE,`${t.data[0]}|${t.data[1]}`)},o.prototype._sendListen=function(){this._connection.sendMsg(this._topic,i.ACTIONS.LISTEN,[this._pattern])},t.exports=o},function(t,e,n){const i=n(13);t.exports={heartbeatInterval:3e4,reconnectIntervalIncrement:4e3,maxReconnectInterval:18e4,maxReconnectAttempts:5,rpcAckTimeout:6e3,rpcResponseTimeout:1e4,subscriptionTimeout:2e3,maxMessagesPerPacket:100,timeBetweenSendingQueuedPackages:16,recordReadAckTimeout:15e3,recordReadTimeout:15e3,recordDeleteTimeout:15e3,path:"/deepstream",mergeStrategy:i.REMOTE_WINS,recordDeepCopy:!0,nodeSocketOptions:null}},function(t,e,n){"use strict";t.exports={REMOTE_WINS(t,e,n,i){i(null,e)},LOCAL_WINS(t,e,n,i){i(null,t.get())}}},function(t,e,n){"use strict";const i=n(0),s=function(t,e){this._options=e,this._client=t,this._register={},this._counter=1,t.on("connectionStateChanged",this._onConnectionStateChanged.bind(this))};n(1)(s.prototype),s.prototype.add=function(t){const e=t.timeout||this._options.subscriptionTimeout;return this._client.getConnectionState()!==i.CONNECTION_STATE.OPEN||e<1?-1:(this.remove(t),t.ackId=this._counter++,t.event=t.event||i.EVENT.ACK_TIMEOUT,t.__timeout=setTimeout(this._onTimeout.bind(this,t),e),this._register[this._getUniqueName(t)]=t,t.ackId)},s.prototype.remove=function(t){if(t.ackId)for(const e in this._register)t.ackId===this._register[e].ackId&&this.clear({topic:this._register[e].topic,action:this._register[e].action,data:[this._register[e].name]});this._register[this._getUniqueName(t)]&&this.clear({topic:t.topic,action:t.action,data:[t.name]})},s.prototype.clear=function(t){let e;e=t.action===i.ACTIONS.ACK&&t.data.length>1?t.topic+t.data[0]+(t.data[1]?t.data[1]:""):t.topic+t.action+t.data[0],this._register[e]&&clearTimeout(this._register[e].__timeout),delete this._register[e]},s.prototype._onTimeout=function(t){if(delete this._register[this._getUniqueName(t)],t.callback)delete t.__timeout,delete t.timeout,t.callback(t);else{const e=`No ACK message received in time${t.name?` for ${t.name}`:""}`;this._client._$onError(t.topic,t.event,e)}},s.prototype._getUniqueName=function(t){return t.topic+t.action+(t.name?t.name:"")},s.prototype._onConnectionStateChanged=function(t){if(t!==i.CONNECTION_STATE.OPEN)for(const t in this._register)clearTimeout(this._register[t].__timeout)},t.exports=s}])}));